<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cat치logo de Liquidaci칩n - Productos en Oferta</title>
    <link rel="stylesheet" href="styles/main.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Header estilo MercadoLibre -->
    <header class="header">
        <div class="header-container">
            <div class="logo" onclick="window.location.href='/'">
                <img src="images/logo.png" alt="Ortis Motos" class="logo-img">
                <span>Cat치logo Digital</span>
            </div>
            <div class="search-bar">
                <input type="text" placeholder="Buscar productos..." id="searchInput">
                <button class="search-btn">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="header-actions">
                <button class="print-btn" onclick="window.print()">
                    <i class="fas fa-print"></i>
                    Imprimir PDF
                </button>
                <button class="admin-btn" onclick="toggleAdminPanel()">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Panel de Administraci칩n -->
    <div class="admin-panel" id="adminPanel" style="display: none;">
        <div class="admin-container">
            <div class="admin-header">
                <h2><i class="fas fa-cog"></i> Panel de Administraci칩n</h2>
                <div class="admin-header-actions">
                    <button class="logout-btn" onclick="logoutAdmin()" title="Cerrar Sesi칩n">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                    <button class="close-admin" onclick="toggleAdminPanel()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
                    <div class="admin-tabs">
                        <button class="tab-btn" onclick="showTab('excel')">
                            <i class="fas fa-file-excel"></i> Importar Excel
                        </button>
                        <button class="tab-btn active" onclick="showTab('import')">
                            <i class="fas fa-table"></i> Editor de Tabla
                        </button>
                    </div>
            
            <!-- Tab Importar Excel -->
            <div class="tab-content" id="excelTab">
                <div class="excel-import-section">
                    <div class="excel-header">
                        <h3><i class="fas fa-file-excel"></i> Importaci칩n Masiva desde Excel</h3>
                        <p>Sube un archivo Excel (.xlsx) con los datos de productos para importaci칩n masiva</p>
                    </div>
                    
                    <div class="excel-upload-area">
                        <div class="upload-zone" id="excelUploadZone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4>Arrastra tu archivo Excel aqu칤</h4>
                            <p>o haz clic para seleccionar</p>
                            <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                            <button class="select-file-btn" onclick="document.getElementById('excelFileInput').click()">
                                <i class="fas fa-folder-open"></i> Seleccionar Archivo
                            </button>
                        </div>
                        
                        <div class="excel-preview" id="excelPreview" style="display: none;">
                            <h4><i class="fas fa-eye"></i> Vista Previa de Datos</h4>
                            <div class="preview-table-container">
                                <table class="preview-table" id="previewTable">
                                    <thead id="previewTableHead"></thead>
                                    <tbody id="previewTableBody"></tbody>
                                </table>
                            </div>
                            <div class="preview-actions">
                                <button class="import-btn" onclick="importExcelData()">
                                    <i class="fas fa-download"></i> Importar a Tabla
                                </button>
                                <button class="cancel-btn" onclick="cancelExcelImport()">
                                    <i class="fas fa-times"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="excel-instructions">
                        <h4><i class="fas fa-info-circle"></i> Instrucciones para el Excel:</h4>
                        <ul>
                            <li><strong>Columna A:</strong> Referencia (ej: REF-001)</li>
                            <li><strong>Columna B:</strong> Descripci칩n del producto</li>
                            <li><strong>Columna C:</strong> Cantidad (n칰mero)</li>
                            <li><strong>Columna D:</strong> Loc (ubicaci칩n o c칩digo interno)</li>
                            <li><strong>Columna E:</strong> Precio en US$ (n칰mero)</li>
                            <li><strong>Columna F:</strong> Categor칤a (KTM, Boutique, Frenos, Buj칤as, Rec General)</li>
                            <li><strong>Fila 1:</strong> Debe contener los encabezados</li>
                        </ul>
                        <div class="excel-template">
                            <button class="download-template-btn" onclick="exportTableToExcel()">
                                <i class="fas fa-download"></i> Exportar / Descargar Plantilla
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Editor de Tabla -->
            <div class="tab-content active" id="importTab">
                <div class="table-editor-section">
                    <div class="editor-header">
                        <h3><i class="fas fa-table"></i> Editor de Productos</h3>
                        <div class="editor-actions">
                            <button class="add-row-btn" onclick="addNewRow()">
                                <i class="fas fa-plus"></i> Agregar Fila
                            </button>
                            <button class="categories-btn" onclick="toggleCategoriesManager()">
                                <i class="fas fa-tags"></i> Gestionar Categor칤as
                            </button>
                            <button class="save-all-btn" onclick="console.log('Bot칩n clickeado'); saveAllProducts();">
                                <i class="fas fa-save"></i> Guardar Todos
                            </button>
                            <button class="view-products-btn" onclick="showExistingProducts()" title="Ver productos existentes">
                                <i class="fas fa-list"></i> Ver Productos
                            </button>
                            <button class="clear-all-btn" onclick="clearAllData()" title="Limpiar todos los datos">
                                <i class="fas fa-trash-alt"></i> Limpiar Todo
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="products-table" id="productsTable">
                            <thead>
                                <tr>
                                    <th>Referencia</th>
                                    <th>Descripci칩n</th>
                                    <th>Categor칤a</th>
                                    <th>Cantidad</th>
                                    <th>Precio (US$)</th>
                                    <th>Im치genes (hasta 3)</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Las filas se generar치n din치micamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="table-info">
                        <p><strong>游눠 Instrucciones:</strong></p>
                        <ul>
                            <li>Haz clic en cualquier celda para editar</li>
                            <li>La <strong>Imagen 1</strong> ser치 la imagen de portada</li>
                            <li>Sube im치genes haciendo clic en el bot칩n de imagen</li>
                            <li>Usa <strong>"Agregar Fila"</strong> para nuevos productos</li>
                            <li>Gestiona categor칤as con el bot칩n <strong>"Gestionar Categor칤as"</strong></li>
                        </ul>
                    </div>
                </div>
                

                <!-- Panel de Gesti칩n de Categor칤as -->
                <div class="categories-manager" id="categoriesManager" style="display: none;">
                    <div class="categories-overlay" onclick="closeCategoriesManager()"></div>
                    <div class="categories-content">
                        <div class="categories-header">
                            <h3><i class="fas fa-tags"></i> Gesti칩n de Categor칤as</h3>
                        </div>
                        <div class="add-category-section">
                            <h4>Agregar Nueva Categor칤a</h4>
                            <div class="category-input-group">
                                <input type="text" id="newCategoryName" placeholder="Nombre de la categor칤a" maxlength="20">
                                <button class="add-category-btn" onclick="addNewCategory()">
                                    <i class="fas fa-plus"></i> Agregar
                                </button>
                            </div>
                        </div>
                        
                        <div class="existing-categories-section">
                            <h4>Categor칤as Existentes</h4>
                            <div class="categories-list" id="categoriesList">
                                <!-- Las categor칤as se cargar치n din치micamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- Contenido principal -->
    <main class="main-container">
        <!-- Sidebar de categor칤as -->
        <aside class="sidebar">
            <h3>Categor칤as</h3>
            <ul class="categories">
                <li class="category-item active" data-category="all">
                    <span>Todas las categor칤as</span>
                    <span class="count">0</span>
                </li>
                <li class="category-item" data-category="ktm">
                    <span>KTM</span>
                    <span class="count">0</span>
                </li>
                <li class="category-item" data-category="boutique">
                    <span>Boutique</span>
                    <span class="count">0</span>
                </li>
                <li class="category-item" data-category="frenos">
                    <span>Frenos</span>
                    <span class="count">0</span>
                </li>
                <li class="category-item" data-category="bujias">
                    <span>Buj칤as</span>
                    <span class="count">0</span>
                </li>
                <li class="category-item" data-category="recgeneral">
                    <span>Rec General</span>
                    <span class="count">0</span>
                </li>
            </ul>
        </aside>

        <!-- Grid de productos -->
        <section class="products-section">
            <div class="products-header">
                <h2>Productos en Liquidaci칩n</h2>
                <p class="products-count">0 productos encontrados</p>
            </div>
            
            <div class="products-grid" id="productsGrid">
                
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>&copy; 2024 Cat치logo de Liquidaci칩n. Todos los derechos reservados.</p>
            <p>Desarrollado por AMS Desarrollos</p>
        </div>
    </footer>

    <!-- Librer칤as para Excel/CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="js/main.js"></script>
    <script>
        function saveAllProducts() {
            console.log('Funci칩n saveAllProducts ejecutada desde SCRIPT INLINE');
            console.log('Datos de tabla:', tableData);
            
            if (tableData.length === 0) {
                alert('No hay productos para guardar');
                return;
            }
            
            let savedCount = 0;
            let hasErrors = false;
            
            // Validar todos los productos primero
            for (let index = 0; index < tableData.length; index++) {
                const row = tableData[index];
                if (!row.referencia || !row.descripcion || row.precio === undefined || row.precio === null || isNaN(parseFloat(row.precio))) {
                    alert(`Fila ${index + 1}: Faltan datos obligatorios (Referencia, Descripci칩n, Precio v치lido)`);
                    hasErrors = true;
                    break;
                }
            }

            if (hasErrors) {
                return;
            }

            const dataToProcess = [...tableData];

            console.log('Procesando productos desde la tabla');

            dataToProcess.forEach((row, index) => {
                const normalizedCategory = row.categoria || 'recgeneral';
                const existingIndex = products.findIndex(p => p.referencia === row.referencia);
                const payload = {
                    referencia: row.referencia,
                    name: row.descripcion,
                    description: row.descripcion,
                    quantity: parseInt(row.cantidad, 10) || 0,
                    loc: row.loc || '',
                    price: parseFloat(row.precio) || 0,
                    category: normalizedCategory,
                    images: (row.imagenes && row.imagenes.length)
                        ? row.imagenes.slice(0, 3)
                        : [row.imagen1, row.imagen2, row.imagen3].filter(Boolean)
                };

                if (!row.imagenes || !row.imagenes.length) {
                    row.imagenes = payload.images;
                }

                if (existingIndex >= 0) {
                    products[existingIndex] = {
                        ...products[existingIndex],
                        ...payload
                    };
                } else {
                    products.push({
                        id: Date.now() + index,
                        rating: 0,
                        reviews: 0,
                        ...payload
                    });
                }

                savedCount++;
            });

            console.log('Productos guardados o actualizados:', savedCount);
            console.log('Total de productos en array:', products.length);

            saveProductsToStorage();
            updateProductsGrid();
            updateCategoryCounts();
            updateSidebarCategories();
            saveTableDataToStorage();
            renderTable();

            // Mostrar notificaci칩n INMEDIATAMENTE
            showSuccessNotification('Cambios guardados');
            
            // Cerrar panel despu칠s de un breve delay para ver la notificaci칩n
            setTimeout(() => {
                closeAdminPanel();
            }, 2000);
        }
    </script>
    
    <!-- Modal de Detalles de Producto -->
    <div id="productModal" class="product-modal" style="display: none;">
        <div class="modal-overlay" onclick="closeProductModal()"></div>
        <div class="modal-content">
            <button class="close-modal" onclick="closeProductModal()">칑</button>
            <div class="modal-body">
                <div class="modal-content-grid">
                    <div class="modal-images-section">
                        <img class="modal-main-image" id="modalMainImage" src="" alt="Producto">
                        <div class="modal-thumbnails" id="modalThumbnails"></div>
                    </div>
                    
                    <div class="modal-info-section">
                        <h2 class="modal-title" id="modalTitle"></h2>
                        <p class="modal-reference" id="modalReference"></p>
                        <p class="modal-description" id="modalDescription"></p>
                        
                        <div class="modal-details">
                            <div class="detail-item">
                                <span class="detail-label">Categor칤a</span>
                                <span class="detail-value" id="modalCategory"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Cantidad</span>
                                <span class="detail-value" id="modalQuantity"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Ubicaci칩n</span>
                                <span class="detail-value" id="modalLocation"></span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Referencia</span>
                                <span class="detail-value" id="modalRef"></span>
                            </div>
                        </div>
                        
                        <div class="modal-price" id="modalPrice"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
